<div class="categories-container">
    <div class="header-section">
        <div class="d-flex align-items-center">
            <button class="back-btn" (click)="goBack()" aria-label="Go back">
                <i class="fa-solid fa-arrow-left"></i>
            </button>
            <h1>Subcategories</h1>
        </div>
        <div class="header-actions">
            <button class="refresh-btn" (click)="refreshSubcategories()" aria-label="Refresh subcategories">
                <i class="fa-solid fa-arrows-rotate"></i>
            </button>
            <button class="create-btn" (click)="openCreateModal()" aria-label="Create subcategory">
                <i class="fa-solid fa-plus"></i> Create
            </button>
        </div>
    </div>

    <!-- Search Section -->
    <div class="search-section" *ngIf="!loading">
        <div class="search-container">
            <div class="search-input-wrapper">
                <i class="fa-solid fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Search subcategories..." [(ngModel)]="searchTerm"
                    (input)="onSearchChange()" />
                <button *ngIf="searchTerm" class="clear-search-btn" (click)="clearSearch()" aria-label="Clear search">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="error-message" *ngIf="error && !showModal">
        <i class="fa-solid fa-circle-exclamation"></i>
        <span>{{ error }}</span>
    </div>

    <div class="loading-spinner" *ngIf="loading && !showModal">
        <i class="fa-solid fa-spinner fa-spin"></i>
        <p>Loading subcategories...</p>
    </div>

    <div class="categories-list" *ngIf="!loading && filteredSubcategories.length > 0">
        <div class="category-item" *ngFor="let subcategory of filteredSubcategories"
            (click)="openSubcategoryDetails(subcategory.id)">
            <div class="category-image-small">
                <img [src]="getImageUrl(subcategory.image)" [alt]="subcategory.name"
                    onerror="this.src='https://test.slingbillings.com/no-image-icon.svg'" />
            </div>
            <div class="category-details">
                <h3 class="category-name">{{ subcategory.name }}</h3>
                <div class="category-meta">
                    <div class="status-row">
                        <span class="parent-category">
                            <i class="fa-solid fa-layer-group"></i>
                            {{ getCategoryName(subcategory.category_id) }}
                        </span>
                        <span class="category-status" [ngClass]="getStatusClass(subcategory.is_active)">
                            <i class="fa-solid"
                                [ngClass]="subcategory.is_active === 1 ? 'fa-check-circle' : 'fa-times-circle'"></i>
                            {{ getStatusText(subcategory.is_active) }}
                        </span>
                    </div>

                </div>
            </div>
            <div class="category-actions" (click)="$event.stopPropagation()">
                <button class="status-toggle-btn"
                    (click)="toggleSubcategoryStatus(subcategory.id, subcategory.is_active)"
                    [title]="subcategory.is_active === 1 ? 'Deactivate' : 'Activate'" aria-label="Toggle status">
                    <i class="fa-solid" [ngClass]="subcategory.is_active === 1 ? 'fa-toggle-on' : 'fa-toggle-off'"></i>
                </button>
                <button class="edit-btn-icon" (click)="openEditModal(subcategory)" aria-label="Edit subcategory">
                    <i class="fa-solid fa-pen"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="no-data" *ngIf="!loading && filteredSubcategories.length === 0 && searchTerm">
        <i class="fa-solid fa-search"></i>
        <p>No subcategories found for "{{ searchTerm }}"</p>
        <button class="create-btn" (click)="clearSearch()">
            <i class="fa-solid fa-times"></i> Clear Search
        </button>
    </div>

    <div class="no-data" *ngIf="!loading && subcategories.length === 0 && !searchTerm">
        <i class="fa-solid fa-folder-open"></i>
        <p>No subcategories found</p>
        <button class="create-btn" (click)="openCreateModal()">
            <i class="fa-solid fa-plus"></i> Create Your First Subcategory
        </button>
    </div>

    <!-- Pagination -->
    <div class="pagination" *ngIf="!loading && totalPages > 1">
        <div class="pagination-info">
            Showing {{ getStartIndex() }} to {{ getEndIndex() }} of {{ totalItems }} subcategories
        </div>
        <div class="pagination-controls">
            <button (click)="goToFirstPage()" [disabled]="currentPage === 1" aria-label="First page">
                <i class="fa-solid fa-angles-left"></i>
            </button>
            <button (click)="previousPage()" [disabled]="currentPage === 1" aria-label="Previous page">
                <i class="fa-solid fa-angle-left"></i>
            </button>

            <button *ngFor="let page of getPageNumbers()" (click)="goToPage(page)" [class.active]="page === currentPage"
                [attr.aria-label]="'Page ' + page">
                {{ page }}
            </button>

            <button (click)="nextPage()" [disabled]="currentPage === totalPages" aria-label="Next page">
                <i class="fa-solid fa-angle-right"></i>
            </button>
            <button (click)="goToLastPage()" [disabled]="currentPage === totalPages" aria-label="Last page">
                <i class="fa-solid fa-angles-right"></i>
            </button>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h2>{{ modalTitle }}</h2>
            <button class="close-btn" (click)="closeModal()" aria-label="Close modal">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>

        <div class="modal-body">
            <div class="error-message" *ngIf="error">
                <i class="fa-solid fa-circle-exclamation"></i>
                <span>{{ error }}</span>
            </div>

            <form (ngSubmit)="submitForm()">
                <div class="form-group">
                    <label for="subcategoryName">Subcategory Name <span class="required">*</span></label>
                    <input type="text" id="subcategoryName" [(ngModel)]="subcategoryName" name="subcategoryName"
                        placeholder="Enter subcategory name" required />
                </div>

                <div class="form-group">
                    <label for="categorySelect">Category <span class="required">*</span></label>
                    <select id="categorySelect" [(ngModel)]="selectedCategoryId" name="categorySelect" required>
                        <option value="">Select a category</option>
                        <option *ngFor="let category of categories" [value]="category.id">
                            {{ category.name }}
                        </option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="subcategoryImage">Subcategory Image (Optional)</label>
                    <div class="image-upload-section">
                        <div class="image-preview" *ngIf="imagePreview">
                            <img [src]="imagePreview" alt="Subcategory preview" />
                            <button type="button" class="remove-image-btn" (click)="removeImage()">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                        <input type="file" id="subcategoryImage" (change)="onImageSelect($event)" accept="image/*" />
                        <label for="subcategoryImage" class="file-label">
                            <i class="fa-solid fa-cloud-arrow-up"></i>
                            {{ selectedImage ? 'Change Image' : 'Upload Image' }}
                        </label>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="cancel-btn" (click)="closeModal()">
                        Cancel
                    </button>
                    <button type="submit" class="submit-btn" [disabled]="loading">
                        <i class="fa-solid fa-spinner fa-spin" *ngIf="loading"></i>
                        <i class="fa-solid fa-check" *ngIf="!loading"></i>
                        {{ loading ? 'Saving...' : (isEditMode ? 'Update' : 'Create') }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Subcategory Details Modal -->
<div class="modal-overlay" *ngIf="showDetailsModal" (click)="closeDetailsModal()">
    <div class="modal-content details-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h2>Subcategory Details</h2>
            <button class="close-btn" (click)="closeDetailsModal()" aria-label="Close modal">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>

        <div class="modal-body">
            <div class="loading-spinner" *ngIf="detailsLoading">
                <i class="fa-solid fa-spinner fa-spin"></i>
                <p>Loading subcategory details...</p>
            </div>

            <div *ngIf="!detailsLoading && selectedSubcategoryDetails" class="category-details-content">
                <div class="details-header">
                    <div class="category-image-large">
                        <img [src]="getImageUrl(selectedSubcategoryDetails.image)"
                            [alt]="selectedSubcategoryDetails.name"
                            onerror="this.src='https://test.slingbillings.com/no-image-icon.svg'" />
                    </div>
                    <div class="category-info">
                        <h3 class="category-title">{{ selectedSubcategoryDetails.name }}</h3>
                        <div class="status-badge" [ngClass]="getStatusClass(selectedSubcategoryDetails.is_active)">
                            <i class="fa-solid"
                                [ngClass]="selectedSubcategoryDetails.is_active === 1 ? 'fa-check-circle' : 'fa-times-circle'"></i>
                            {{ getStatusText(selectedSubcategoryDetails.is_active) }}
                        </div>
                    </div>
                </div>

                <div class="details-grid">
                    <div class="detail-item">
                        <label>Subcategory ID</label>
                        <span>{{ selectedSubcategoryDetails.id }}</span>
                    </div>
                    <div class="detail-item">
                        <label>Category</label>
                        <span>{{ getCategoryName(selectedSubcategoryDetails.category_id) }}</span>
                    </div>
                    <div class="detail-item">
                        <label>User ID</label>
                        <span>{{ selectedSubcategoryDetails.user_id }}</span>
                    </div>
                    <div class="detail-item">
                        <label>Bulk Upload</label>
                        <span>{{ selectedSubcategoryDetails.is_bulk_upload === 1 ? 'Yes' : 'No' }}</span>
                    </div>
                    <div class="detail-item" *ngIf="selectedSubcategoryDetails.run_id">
                        <label>Run ID</label>
                        <span>{{ selectedSubcategoryDetails.run_id }}</span>
                    </div>
                    <div class="detail-item">
                        <label>Created At</label>
                        <span>{{ formatDate(selectedSubcategoryDetails.created_at) }}</span>
                    </div>
                    <div class="detail-item">
                        <label>Updated At</label>
                        <span>{{ formatDate(selectedSubcategoryDetails.updated_at) }}</span>
                    </div>
                </div>

                <div class="details-actions">
                    <button class="status-toggle-btn-large"
                        (click)="toggleSubcategoryStatus(selectedSubcategoryDetails.id, selectedSubcategoryDetails.is_active)">
                        <i class="fa-solid"
                            [ngClass]="selectedSubcategoryDetails.is_active === 1 ? 'fa-toggle-on' : 'fa-toggle-off'"></i>
                        {{ selectedSubcategoryDetails.is_active === 1 ? 'Deactivate' : 'Activate' }}
                    </button>
                    <button class="edit-btn" (click)="openEditModal(selectedSubcategoryDetails); closeDetailsModal()">
                        <i class="fa-solid fa-pen"></i> Edit Subcategory
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>